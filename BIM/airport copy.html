<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="UTF-8">
 <title>bimModel</title>
</head>

<body>
 <div id="bimModel" style="width: 800px; height: 600px;"></div>
 <script type="module">

  import * as THREE from './three.js';
  import { OrbitControls } from './OrbitControls.js';

  import { OBJLoader } from './OBJLoader.js';
  import { STLLoader } from './STLLoader.js';


  let camera, scene, renderer, controls;
  var bridge1 = [];
  var bridge2 = [];
  var bridge3 = [];

  //camera 設定
  var C = { "position": { "x": 369.3854947438097, "y": 454.35932352314717, "z": -209.20262692816544 }, "rotation": { "_x": -1.5707953267595884, "_y": 4.275900921096171e-9, "_z": 0.0042757238964344635, "_order": "XYZ" }, "quaternion": { "_x": -0.7071048117193711, "_y": 0.0015116962851839959, "_z": 0.0015116947734212728, "_w": 0.7071055188559668 }, "fov": 75, "aspect": 1.3333333333333333, "near": 0.1, "far": 5000, "zoom": 1, "target": { "x": 369.38549280101427, "y": -2.2019625328676434e-15, "z": -209.2030813035315 }, "object_zoom": 1 };

  //空橋1
  var bridgeData1 = [{ "index": 0, "name": "T.stl", "position": { "x": 0, "y": 3, "z": -4 }, "scale": { "x": 0.3, "y": 0.2, "z": 0.35 }, "rotation": { "_x": 0, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#ee0000" }, { "index": 1, "name": "Group_29.stl", "position": { "x": 3.5, "y": 2.5, "z": 43 }, "scale": { "x": 10, "y": 1.5, "z": 1 }, "rotation": { "_x": 0, "_y": 2.2689280275926285, "_z": 0, "_order": "XYZ" }, "color": "#555555" }, { "index": 2, "name": "JetBridge.stl", "position": { "x": 9, "y": -1, "z": 11 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#eeeeee" }, { "index": 3, "name": "JetBridge.stl", "position": { "x": 0, "y": -1, "z": 13 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#eeeeee" }, { "index": 4, "name": "a380.stl", "position": { "x": 30, "y": -1, "z": 40 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#005500" }, { "index": 5, "name": "BuildingwithStair1.stl", "position": { "x": 0, "y": 0, "z": -15 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#00eeee" }, { "index": 6, "name": "BuildingwithStair1.stl", "position": { "x": 70, "y": 0, "z": -15 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#00eeee" }, { "index": 7, "name": "BuildingwithStair1.stl", "position": { "x": 35, "y": 0, "z": -15 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#00eeee" }];

  //空橋2
  var bridgeData2 = [{ "index": 0, "name": "T.stl", "position": { "x": 75, "y": 2, "z": -25 }, "scale": { "x": 0.5, "y": 0.3, "z": 0.6 }, "rotation": { "_x": 0, "_y": 3.141592653589793, "_z": 0, "_order": "XYZ" }, "color": "#ee0000" }, { "index": 1, "name": "Group_29.stl", "position": { "x": 66.5, "y": 4.5, "z": -68 }, "scale": { "x": 10, "y": 1.5, "z": 1 }, "rotation": { "_x": 0, "_y": 2.2689280275926285, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#555555" }, { "index": 2, "name": "JetBridge.stl", "position": { "x": 72, "y": -2, "z": -50 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#eeeeee" }, { "index": 3, "name": "JetBridge.stl", "position": { "x": 60, "y": -2, "z": -50 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 3.141592653589793, "_order": "XYZ" }, "color": "#eeeeee" }, { "index": 4, "name": "a380.stl", "position": { "x": 50, "y": 0, "z": -80 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#005500" }, { "index": 5, "name": "BuildingwithStair1.stl", "position": { "x": 0, "y": 0, "z": -15 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#00eeee" }, { "index": 6, "name": "BuildingwithStair1.stl", "position": { "x": 70, "y": 0, "z": -15 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#00eeee" }, { "index": 7, "name": "BuildingwithStair1.stl", "position": { "x": 35, "y": 0, "z": -15 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#00eeee" }];

  //空橋3
  var bridgeData3 = [{ "index": 0, "name": "JetBridge.stl", "position": { "x": 0, "y": -2, "z": 0 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 1.5707963267948966, "_order": "XYZ" }, "color": "#eeeeee" }, { "index": 1, "name": "JetBridge.stl", "position": { "x": 15, "y": -2, "z": 0 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 1.5707963267948966, "_order": "XYZ" }, "color": "#eeeeee" }, { "index": 2, "name": "a380.stl", "position": { "x": -25, "y": 0, "z": 5 }, "scale": { "x": 1, "y": 1, "z": 1 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 1.5707963267948966, "_order": "XYZ" }, "color": "#005500" }];

  //主建築
  var mainBuilding = [{ "index": 0, "name": "Concept.stl", "position": { "x": 70, "y": 0, "z": -70 }, "scale": { "x": 50, "y": 200, "z": 65 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#555555" }, { "index": 1, "name": "Concept.stl", "position": { "x": 170, "y": 0, "z": -70 }, "scale": { "x": 50, "y": 200, "z": 65 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#555555" }, { "index": 2, "name": "Concept.stl", "position": { "x": 270, "y": 0, "z": -70 }, "scale": { "x": 50, "y": 200, "z": 65 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#555555" }, { "index": 3, "name": "Concept.stl", "position": { "x": 370, "y": 0, "z": -70 }, "scale": { "x": 50, "y": 200, "z": 65 }, "rotation": { "_x": -1.5707963267948966, "_y": 0, "_z": 0, "_order": "XYZ" }, "color": "#555555" }];

  function init() {
   // Scene setup
   scene = new THREE.Scene();
   // 添加天空背景
   scene.background = new THREE.Color('skyblue');
   // 添加地面
   var planeGeometry = new THREE.PlaneGeometry(10000, 10000); // 創建一個平面幾何體，寬和長均為10000
   var planeMaterial = new THREE.MeshLambertMaterial({ color: 0xc0f8b1 }); // 為平面創建材質，設定顏色為淺綠色
   var plane = new THREE.Mesh(planeGeometry, planeMaterial); // 使用幾何體和材質創建Mesh
   plane.rotation.x = -Math.PI / 2; // 將平面旋轉為水平，面向上方
   plane.position.y = -1; // 將地面位置稍微下降，避免與模型重疊
   scene.add(plane); // 將平面添加到場景中

   // 創建相機
   camera = new THREE.PerspectiveCamera(C.fov, C.aspect, C.near, C.far); // 使用配置參數創建透視相機
   camera.position.set(C.position.x, C.position.y, C.position.z); // 設定相機位置
   camera.rotation.set(C.rotation._x, C.rotation._y, C.rotation._z); // 設定相機旋轉
   camera.quaternion.set(C.quaternion._x, C.quaternion._y, C.quaternion._z, C.quaternion._w); // 設定相機四元數，用於控制旋轉
   camera.zoom = C.zoom; // 設定相機的縮放級別
   camera.updateProjectionMatrix(); // 更新相機的投影矩陣

   // 初始化渲染器
   renderer = new THREE.WebGLRenderer(); // 創建WebGL渲染器
   renderer.setSize(800, 600); // 設定渲染器的大小
   document.getElementById('bimModel').appendChild(renderer.domElement); // 將渲染器的DOM元素掛載到HTML中的指定元素上

   // 添加照明
   const light = new THREE.DirectionalLight(0xffffff, 1); // 創建一個白色的方向光源
   light.position.set(1, 1, 1).normalize(); // 設定光源的位置並正規化
   scene.add(light); // 將光源添加到場景中

   // 實例化OrbitControls，允許用戶通過拖動來旋轉視角，滾動來縮放
   controls = new OrbitControls(camera, renderer.domElement);
   controls.enableDamping = true; // 啟用阻尼效果，使交互更加平滑
   controls.dampingFactor = 0.25; // 設定阻尼系數
   controls.screenSpacePanning = false; // 禁用屏幕空間平移
   controls.target.set(C.target.x, C.target.y, C.target.z); // 設定控制的目標點
   controls.update(); // 更新控制器的內部狀態

   // 设置最小极角为0，防止低于地平面
   // Math.PI / 2 是90度，意味着视线平行于地面，不允许更低
   controls.minPolarAngle = 0; // 不允许移动到地面以下
   controls.maxPolarAngle = Math.PI / 2; // 最大旋转角度
   for (var c = 0; c < 8; c++)
    bridge1.push([]);
   for (var c = 0; c < 8; c++)
    bridge2.push([]);
   for (var c = 0; c < 5; c++)
    bridge3.push([]);
   // Handle STL upload 


   // 加載和顯示模型的通用函數
   function loadModels(_objCollect, tmpData, xOffset = 0, xIncrement = 0, zOffset = 0, zIncrement = 0) {
    for (let c = 0; c < _objCollect.length; c++) {
     tmpData.forEach((item, i) => {
      if (item.name.indexOf('.stl') > -1) {
       const loader = new STLLoader();
       loader.load(item.name, function (geometry) {
        var material = new THREE.MeshPhongMaterial({ color: item.color });
        var stlModel = new THREE.Mesh(geometry, material);
        scene.add(stlModel);

        // 設置模型位置、縮放和旋轉
        stlModel.position.set(item.position.x + c * xIncrement, item.position.y, item.position.z - zOffset - c * zIncrement);
        stlModel.scale.set(item.scale.x, item.scale.y, item.scale.z);
        stlModel.rotation.set(item.rotation._x, item.rotation._y, item.rotation._z);

        _objCollect[c].push(stlModel);
       });
      }
      else if (item.name.indexOf('light') > -1) {
       const pointLight = new THREE.PointLight(item.color, 1, 50); // 紅色光源
       pointLight.position.set(item.position.x, item.position.y, item.position.z); // 設定光源位置
       scene.add(pointLight);
       stlModels.push(pointLight);
       stlName.push(item.name);
       stlPosition.push(item.position);

      }
      else if (item.name.indexOf('sphere') > -1) {
       const sphereSize = 0.5;
       const bulbGeometry = new THREE.SphereGeometry(sphereSize, 16, 8);
       const bulbMaterial = new THREE.MeshBasicMaterial({ color: item.color }); // 與光源顏色相同
       const bulb = new THREE.Mesh(bulbGeometry, bulbMaterial);
       bulb.position.set(item.position.x, item.position.y, item.position.z);  // 設置與光源相同的位置
       scene.add(bulb);
       stlModels.push(bulb);
       stlName.push(item.name);
       stlPosition.push(item.position);
      }
     });
    }
   }

   // 呼叫 loadModels 函數來加載和顯示所有模型
   loadModels(bridge1, bridgeData1, 0, 98);     // 加載 bridge1
   loadModels(bridge2, bridgeData2, 0, 98, 405);  // 加載 bridge2
   loadModels(bridge3, bridgeData3, 50, 0, 80, 70); // 加載 bridge3
   loadModels([[]], mainBuilding);  // 直接加載 


   let sumX = 0, sumY = 0, sumZ = 0;
   let count = 0;

   // 计算所有对象的坐标平均值
   scene.traverse(function (object) {
    if (object.isMesh) {
     sumX += object.position.x;
     sumY += object.position.y;
     sumZ += object.position.z;
     count++;
    }
   });

   const centerX = sumX / count;
   const centerY = sumY / count;
   const centerZ = sumZ / count;

   // 设置摄像机看向新的中心点
   camera.lookAt(centerX, centerY, centerZ);
   camera.updateProjectionMatrix();

   // Raycaster和鼠标位置
   const raycaster = new THREE.Raycaster();
   const mouse = new THREE.Vector2();

   function onMouseClick(event) {
    // 计算鼠标在场景中的位置
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

    // 更新raycaster的射线方向
    raycaster.setFromCamera(mouse, camera);

    // 计算物体和射线的交点
    const intersects = raycaster.intersectObjects(scene.children);

    if (intersects.length > 0) {
     // 如果有物体被选中，则改变最近的物体的颜色
     console.log(intersects[0]);
     //intersects[0].object.material.color.setHex(Math.random() * 0xffffff);
    }
   }

   // 监听鼠标点击事件
   window.addEventListener('mousedown', onMouseClick, false);


   animate();
  }


  function animate() {
   requestAnimationFrame(animate);
   controls.update(); // 只有当 enableDamping 或 autoRotate 被设置时才需要
   renderer.render(scene, camera);
  }

  init();

 </script> <!-- Your JavaScript code will go here -->
</body>

</html>